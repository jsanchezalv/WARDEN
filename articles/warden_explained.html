<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>WARDEN Explained • WARDEN</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="WARDEN Explained">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZEDNGW5QRP"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZEDNGW5QRP');
</script><!-- Google tag (gtag.js) -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WARDEN</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="View Index"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Core Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/warden_explained.html">Warden Explained</a></li>
    <li><a class="dropdown-item" href="../articles/example_ssd.html">Sick-Sicker-Dead Model (SSD)</a></li>
    <li><a class="dropdown-item" href="../articles/example_ssd_constrained.html">Resource Constrained SSD model</a></li>
    <li><a class="dropdown-item" href="../articles/inputs_selector.html">How to Use the Automatic Input Selector</a></li>
    <li><a class="dropdown-item" href="../articles/example_eBC.html">Early Breast Cancer</a></li>
    <li><a class="dropdown-item" href="../articles/example_ipd.html">Using Individual Patient Data</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Other Tutorials and Best Practices</h6></li>
    <li><a class="dropdown-item" href="../articles/example_markov.html">Cohort Markov Model</a></li>
    <li><a class="dropdown-item" href="../articles/example_avoiding_cycles.html">How to Avoid Using Cycles to Speed Up Model</a></li>
    <li><a class="dropdown-item" href="../articles/example_uncertainty.html">Structural and Parametric Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/example_ssd_stream.html">Random Number Streams &amp; Luck Adjustment (SSD model)</a></li>
    <li><a class="dropdown-item" href="../articles/example_ssd_sobol.html">Quasi-Random Sobol Sequence vs. Purely Random (SSD model)</a></li>
    <li><a class="dropdown-item" href="../articles/example_colon_degeling.html">Degeling (2025) using WARDEN instead of simmer</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jsanchezalv/WARDEN" aria-label="View on Github"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>WARDEN Explained</h1>
                        <h4 data-toc-skip class="author">Javier Sanchez
Alvarez</h4>
            
            <h4 data-toc-skip class="date">October 08, 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jsanchezalv/WARDEN/blob/main/vignettes/articles/warden_explained.Rmd" class="external-link"><code>vignettes/articles/warden_explained.Rmd</code></a></small>
      <div class="d-none name"><code>warden_explained.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document explains the logic behind WARDEN main approach to
simulate discrete event simulations, as well as explaining briefly the
rationale for certain design decisions.</p>
<div class="section level3">
<h3 id="in-a-nutshell">In a Nutshell<a class="anchor" aria-label="anchor" href="#in-a-nutshell"></a>
</h3>
<p>WARDEN main simulation engine at its core is nothing but a nested
loop at different levels. However, for this to work we need to delay the
execution of the inputs provided by the user, so the relevant inputs
provided through <code><a href="../reference/add_tte.html">add_tte()</a></code>, <code><a href="../reference/add_item.html">add_item()</a></code> and
<code><a href="../reference/add_reactevt.html">add_reactevt()</a></code> are substituted for delayed execution and
stored as lists.</p>
<p>The basic engine works as indicated below. This is the engine used
for unconstrained DES. For constrained DES, the only difference is that
once all inputs are loaded (analysis, simulation, arm, patient), they
are all saved, and we then iterate over the queue of events in order,
loading the corresponding inputs for the patient for which the event
applies, evaluating the event, and then moving on to the next event (and
the corresponding patient).</p>
<ol style="list-style-type: decimal">
<li>
<strong>Per Analysis (DSA, scenarios) “sens”</strong>
<ol style="list-style-type: decimal">
<li>Load inputs sequentially and assign to the “sens” input
environment.</li>
<li>
<strong>Per Simulation (PSA or deterministic) “simulation”</strong>
<ol style="list-style-type: decimal">
<li>Load inputs sequentially and store its components. The “sens”
environment is integrated into a new environment with the “simulation”
input environment.</li>
<li>
<strong>Per Patient “i”</strong>
<ol style="list-style-type: decimal">
<li>Load inputs sequentially and store its components. The “simulation”
environment is integrated into a new environment with the “i” input
environment</li>
<li>
<strong>Per Arm “arm”</strong>
<ol style="list-style-type: decimal">
<li>Load inputs sequentially and store its components. The “i”
environment is integrated into a new environment with the “arm” input
environment</li>
<li>Load initial time to events. First look into the initial time to
event expression declared by user; if not found, look into the input
list already declared; if not found, set equal to <code>Inf</code>.
Events are added to an event queue object defined within C++ for
efficient management of the queue.</li>
<li>
<strong>While <code>curtime</code> (simulation time) is &lt;
<code>Inf</code></strong>
<ol style="list-style-type: decimal">
<li>Select the next event by checking the event queue; in case of ties,
untie using the order declared in <code>add_tte</code> for initial time
to events. If there are no events left, the event time is
<code>Inf</code> or if the user sets <code>curtime = Inf</code> then the
simulation ends.</li>
<li>Evaluate the reaction of the event by looking at the relevant
expression from the list of event reactions</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>Once the specific “simulation” is done, compute outputs vectorized
(discount outcomes as relevant based on their type, aggregate data as
relevant, obtain timed frequency outputs if needed, etc.)</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>The debug mode will store in a log the relevant data that is loaded
or changed by the event reactions, and will be exported when the
simulation stops (also on error). WARDEN allows to continue on error
(though not recommended)</p>
<p>WARDEN handles the random numbers automatically, setting the seeds
differently at the simulation, patient and arm level. WARDEN makes sure
that the starting seed is cloned for a patient across interventions.
However, it could be that conditional statements can alter the random
state of R if they conditional trigger random expressions (e.g.,
<code>if(arm==2){runif(1)}else{5}</code>) that change per intervention.
To keep the random number cloned as intended, it’s very strongly
recommended to pre-draw random numbers for each type of random object
used and use those (see the <code>vignette("example_ssd_stream")</code>
vignette for more information). WARDEN uses L’Ecuyer-CMRG random number
generator.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">#Code can be writing directly as an expression which will be evaluated at the right time</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">add_reactevt</span>(<span class="at">name_evt =</span> <span class="st">"event_1"</span>, <span class="at">input =</span> {</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  a  <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  z  <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  b  <span class="ot">&lt;-</span> z <span class="sc">+</span> <span class="dv">1</span> </span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  c  <span class="ot">&lt;-</span> b <span class="sc">+</span> <span class="dv">5</span> <span class="co">#b will be available </span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="storing-inputs-making-it-faster">Storing Inputs, Making it Faster<a class="anchor" aria-label="anchor" href="#storing-inputs-making-it-faster"></a>
</h3>
<p>Multiple ways of storing inputs and processing events can be thought
of. A few of these could be 1) data.frames, 2) lists, 3) environments,
or 4) utilize a C++ implementation (among others). WARDEN uses
environments to store inputs, and a queue with unordered maps in C++ to
process events.</p>
<p>Data.frames can be slow and memory-intense to manipulate, so they
were avoided for this purpose.</p>
<p>[Changed with WARDEN 1.0] The limitation with the debugging mode has
been handled by extract the abstract syntax tree of the event reactions
and looking for any type of assignments. A limitation of this is that
“dynamic” assignments (e.g., <code>assign(paste0("x_",i), 5)</code>
where <code>i</code> is created by a loop) are NOT captured by the
debugging engine, and therefore will be excluded from the debugging log
file. So the user should try to assign variables explicitly whenever
possible, e.g., <code>x_1 &lt;- 5</code>.</p>
<p>[Changed with WARDEN 2.0] A C++ implementation was avoided for a long
time as the purpose of WARDEN is to be user-friendly and to give the
user as much as freedom as possible on how to define their inputs. While
it can make the constrained implementation doable and faster,
implementation in C++ requires careful consideration on how the user can
interact with the object in question. [Changed with WARDEN 2.0] In the
most recent version of WARDEN, several functions now use a C++ function
under the hood for speed improvement, but the user will not notice any
change relative to the R counterpart. The core engine has been revamped
so that events now use a C++ implementation of a queue, but it has been
designed so that users can interact as before with the queue using pure,
simple R (so <code><a href="../reference/modify_event.html">modify_event()</a></code> is still used, etc).
Furthermore, a resource-constrained engine has been created and a
discrete constrained resource object has been created using C++. Again,
the user can interact with these objects using clear R functions.
Speed-wise, for the unconstrained set-up the user is unlikely to see
large speed gains, as there is an implicit cost of setting up each event
queue, modifying events, etc. The constrained approach can achieve
similar speeds to the unconstrained method.</p>
<p>Several objects now in WARDEN use an R6-like interaction,
particularly the random streams (<code><a href="../reference/random_stream.html">random_stream()</a></code>),
restricted resources (<code><a href="../reference/resource_discrete.html">resource_discrete()</a></code>) and shared
inputs across patients (<code><a href="../reference/shared_input.html">shared_input()</a></code>). The reason to
select this type of object is due to the type of interaction the user
needs to perform with this objects. For example for random streams we
want to do two things at once: 1) draw a random number from a
pre-generated list of random numbers, and 2) also remove the last used
number from the list. For a discrete resource, we want a patient to
attempt to block the resource, and to also modify at the same time the
discrete resource object (add the patient status to be using the
resource, or to join the queue). This solution makes the code much
easier to implement from a user perspective.</p>
</div>
<div class="section level3">
<h3 id="parallel-engine-approach">Parallel engine approach<a class="anchor" aria-label="anchor" href="#parallel-engine-approach"></a>
</h3>
<p>Furthermore, a parallel core/thread implementation is also available
at the simulation level, i.e., it will perform the “simulation” loop in
parallel. The reason to select the simulation and not the patient is
that each patient normally takes a small amount of time to run, and the
simulation level offers the right balance in terms of time to run.</p>
<p>However, the user should expect it to be only slightly more efficient
(perhaps 20-40% speed increase for medium to large simulations), as
opposed to radically faster. Two factors will be important: the number
of simulations to be run (<code>n_sim</code>), and the size of each
simulation (given by the number of events and the number of patients and
arms). If <code>n_sim</code> is small, it may not be worth it to use a
parallel approach as there is a time loss to set up the different
cores/threads (normally 2 to 5 seconds), so if each simulations runs
fast because they are simple (a couple or seconds or so) it may not be
worth it. Even if <code>n_sim</code> is large and each simulation is
complex, the efficiency gain may be ~20-40%, even if using &gt;5 cores.
The reason is that RAM use increases fast as R creates new sessions with
duplicated data (it’s not shared among the cores/threads), and a medium
to large simulation can easily become &gt;2 GB of RAM use per
simulation, so systems with large processing power AND large RAM (e.g.,
32 or 64GB) will benefit the most from this approach.</p>
<p>The parallel implementation also has limitations in terms of
exporting logs if there is an error in a simulation (due to the parallel
set-up), so this approach is recommended when the user is quite
confident that the simulation will run without issues.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Javier Sanchez Alvarez.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
